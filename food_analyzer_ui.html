<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Analyzer Agent</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üß† Food Analyzer Agent</h1>
        <p class="subtitle">Agente inteligente con DSPy para an√°lisis de comida</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('analyze')">üçΩÔ∏è Analizar</button>
            <button class="tab" onclick="switchTab('nutrition')">ü•ó Nutrici√≥n</button>
            <button class="tab" onclick="switchTab('compare')">‚öñÔ∏è Comparar</button>
        </div>

        <!-- Tab 1: Analizar -->
        <div id="analyze-tab" class="tab-content active">
            <div class="upload-area" id="uploadArea">
                üì∏ Haz clic o arrastra una imagen aqu√≠
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <img id="previewImage" style="display:none;">
            <button class="btn" id="analyzeBtn" disabled>Analizar Comida</button>
            <div id="loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                Analizando imagen...
            </div>
            <div id="error" class="error" style="display:none;"></div>
            <div id="results" class="results" style="display:none;">
                <h2 id="plateName"></h2>
                <h3>üìù Ingredientes</h3>
                <ul id="ingredientsList"></ul>
                <h3>üë®‚Äçüç≥ Pasos de preparaci√≥n</h3>
                <ol id="stepsList"></ol>
                <h3>üí° Datos curiosos</h3>
                <ul id="curiositiesList"></ul>
            </div>
        </div>

        <!-- Tab 3: Nutrici√≥n -->
        <div id="nutrition-tab" class="tab-content">
            <h2>ü•ó Calcular Informaci√≥n Nutricional</h2>
            <input type="text" id="nutritionDish" placeholder="Nombre del plato">
            <textarea id="nutritionIngredients" placeholder="Ingredientes (uno por l√≠nea, opcional)" rows="5"></textarea>
            <button class="btn" onclick="calculateNutrition()">Calcular Nutrici√≥n</button>
            <div id="nutritionLoading" class="loading" style="display:none;">
                <div class="spinner"></div>
                Calculando informaci√≥n nutricional...
            </div>
            <div id="nutritionError" class="error" style="display:none;"></div>
            <div id="nutritionResult"></div>
        </div>

        <!-- Tab 4: Comparar -->
        <div id="compare-tab" class="tab-content">
            <h2>‚öñÔ∏è Comparar Platos Guardados</h2>
            <p style="color: #666; margin-bottom: 20px;">Selecciona dos an√°lisis guardados para compararlos</p>
            <button class="btn-secondary" onclick="loadAnalysesForComparison()">üîÑ Cargar An√°lisis Disponibles</button>
            <select id="analysis1Select"><option value="">Selecciona Plato 1...</option></select>
            <div id="analysis1Preview" style="display:none;"></div>
            <select id="analysis2Select"><option value="">Selecciona Plato 2...</option></select>
            <div id="analysis2Preview" style="display:none;"></div>
            <button class="btn" onclick="compareDishes()">Comparar Platos</button>
            <div id="compareLoading" class="loading" style="display:none;">
                <div class="spinner"></div>
                Comparando platos...
            </div>
            <div id="compareError" class="error" style="display:none;"></div>
            <div id="compareResult"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8000';
        let selectedFile = null;
        let availableAnalyses = [];

        function switchTab(name) {
            document.querySelectorAll('.tab-content, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(name + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // TAB 1: ANALIZAR
        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('previewImage');
                    img.src = ev.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(selectedFile);
                document.getElementById('analyzeBtn').disabled = false;
            }
        };

        document.getElementById('analyzeBtn').onclick = async () => {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            results.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                const res = await fetch(`${API}/analyze_food`, { method: 'POST', body: formData });
                const data = await res.json();
                console.log(data);
                

                document.getElementById('plateName').textContent = data.nombre_plato;
                document.getElementById('ingredientsList').innerHTML = data.receta.ingredientes.map(i => `<li>${i}</li>`).join('');
                document.getElementById('stepsList').innerHTML = data.receta.pasos.map(p => `<li>${p}</li>`).join('');
                document.getElementById('curiositiesList').innerHTML = data.datos_curiosos.map(c => `<li>${c}</li>`).join('');
                results.style.display = 'block';
            } catch (err) {
                error.textContent = 'Error: ' + err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        };

        // TAB 3: NUTRICI√ìN
        async function calculateNutrition() {
            const dish = document.getElementById('nutritionDish').value;
            const ingredients = document.getElementById('nutritionIngredients').value.split('\n').filter(i => i.trim());
            const loading = document.getElementById('nutritionLoading');
            const error = document.getElementById('nutritionError');
            const result = document.getElementById('nutritionResult');

            if (!dish) {
                error.textContent = 'Por favor ingresa el nombre del plato';
                error.style.display = 'block';
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            result.innerHTML = '';

            try {
                const url = `${API}/nutrition/${encodeURIComponent(dish)}${ingredients.length ? '?ingredients=' + encodeURIComponent(ingredients.join(',')) : ''}`;
                const res = await fetch(url);
                const data = await res.json();

                const n = data.nutrition;
                let html = `
                    <div class="results">
                        <h2>Informaci√≥n Nutricional</h2>
                        <h3>üçΩÔ∏è ${dish}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Calor√≠as</p>
                                <p style="font-size: 1.5em; font-weight: bold; color: #667eea;">${n.calories}</p>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #764ba2;">
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Prote√≠nas</p>
                                <p style="font-size: 1.5em; font-weight: bold; color: #764ba2;">${n.protein}</p>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Carbohidratos</p>
                                <p style="font-size: 1.5em; font-weight: bold; color: #ff6b6b;">${n.carbohydrates}</p>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #feca57;">
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Grasas</p>
                                <p style="font-size: 1.5em; font-weight: bold; color: #feca57;">${n.fats}</p>
                            </div>
                        </div>
                        <p><b>üåæ Fibra:</b> ${n.fiber}</p>
                        <p><b>Tama√±o de la porcion:</b> ${n.serving_size}</p>`;
                
                if (data.agent_reasoning) {
                    html += `<details class="agent-reasoning">
                        <summary>üß† Ver razonamiento del agente</summary>
                        <p style="margin-top: 10px;">${data.agent_reasoning}</p>
                    </details>`;
                }
                html += '</div>';
                result.innerHTML = html;
            } catch (err) {
                error.textContent = 'Error: ' + err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // TAB 4: COMPARAR
        async function loadAnalysesForComparison() {
            try {
                const res = await fetch(`${API}/history?limit=50`);
                const data = await res.json();
                availableAnalyses = data.history;

                const select1 = document.getElementById('analysis1Select');
                const select2 = document.getElementById('analysis2Select');
                
                select1.innerHTML = '<option value="">Plato 1...</option>';
                select2.innerHTML = '<option value="">Plato 2...</option>';
                
                availableAnalyses.forEach(a => {
                    select1.innerHTML += `<option value="${a.id}">${a.dish_name} (ID:${a.id})</option>`;
                    select2.innerHTML += `<option value="${a.id}">${a.dish_name} (ID:${a.id})</option>`;
                });
                
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAnalysesForComparison();
            
            ['analysis1Select', 'analysis2Select'].forEach((id, idx) => {
                document.getElementById(id).onchange = (e) => {
                    const preview = document.getElementById(id.replace('Select', 'Preview'));
                    const analysis = availableAnalyses.find(a => a.id == e.target.value);
                    if (analysis) {
                        preview.innerHTML = `<b>${analysis.dish_name}</b><br><small>${analysis.ingredients.join(', ')}</small>`;
                        preview.style.display = 'block';
                    } else {
                        preview.style.display = 'none';
                    }
                };
            });
        });

        async function compareDishes() {
            const id1 = document.getElementById('analysis1Select').value;
            const id2 = document.getElementById('analysis2Select').value;
            const loading = document.getElementById('compareLoading');
            const error = document.getElementById('compareError');
            const result = document.getElementById('compareResult');

            if (!id1 || !id2) {
                error.textContent = 'Selecciona ambos platos';
                error.style.display = 'block';
                return;
            }
            if (id1 === id2) {
                error.textContent = 'Deben ser diferentes';
                error.style.display = 'block';
                return;
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            result.innerHTML = '';

            try {
                const res = await fetch(`${API}/compare?analysis_id1=${id1}&analysis_id2=${id2}`);
                const data = await res.json();
                const c = data.comparison;

                result.innerHTML = `
                    <div class="results">
                        <h2>‚öñÔ∏è Comparaci√≥n de Platos</h2>
                        <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white;">
                                <h3 style="color: white; margin: 0 0 10px 0;">${data.dish1.name}</h3>
                                <p style="font-size: 0.9em; opacity: 0.9;">ID: ${data.dish1.id}</p>
                                <p style="font-size: 0.9em; opacity: 0.9;">${data.dish1.ingredients.join(', ')}</p>
                            </div>
                            <div style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); padding: 20px; border-radius: 15px; color: white;">
                                <h3 style="color: white; margin: 0 0 10px 0;">${data.dish2.name}</h3>
                                <p style="font-size: 0.9em; opacity: 0.9;">ID: ${data.dish2.id}</p>
                                <p style="font-size: 0.9em; opacity: 0.9;">${data.dish2.ingredients.join(', ')}</p>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 15px; text-align: center; margin: 20px 0; border: 3px solid #667eea;">
                            <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Similitud</p>
                            <p style="font-size: 3em; font-weight: bold; color: #667eea; margin: 0;">${c.similarity_score}%</p>
                        </div>
                        
                        <h3>üç≥ Relaci√≥n Culinaria</h3>
                        <p style="white-space: pre-wrap; line-height: 1.6;">${c.culinary_relationship}</p>
                        
                        <h3>üåç Contexto Cultural</h3>
                        <p style="white-space: pre-wrap; line-height: 1.6;">${c.cultural_context}</p>
                        
                        ${data.agent_reasoning ? `
                            <details class="agent-reasoning">
                                <summary>üß† Ver razonamiento del agente</summary>
                                <p style="margin-top: 10px; white-space: pre-wrap;">${data.agent_reasoning}</p>
                            </details>
                        ` : ''}
                    </div>`;
            } catch (err) {
                error.textContent = 'Error: ' + err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
